{% comment %}@overview Iterates over an array of content blocks, including nested content arrays, outputting the relevant content{% endcomment %}{% 
comment %}@param contentArray {Array} Array of content blocks to process{% endcomment %}{% 
comment %}@param currHeadingLevel (Integer} Preceding heading level (i.e., heading level for the section that contentArray is contained within){% endcomment %}{% 
comment %}@param relevantTags {String/Array} Optional (defaults to all). Comma-separated tags or array of tags that content must have at least one of to be displayed.{% endcomment %}{% 
comment %}@param collapseSubsections {Boolean} Optional (defaults to false). Whether or not the heading and section elements for a sub-section (i.e., section found in a content array) should be output (does not affect content within the sub-section and replaces section with a div).{% endcomment %}{% 
comment %}@return {String} Returns the processed output from the content array{% endcomment %}{%  
for item in include.contentArray %}{% 
  comment %}Have to restart with include.relevantTags on each loop to avoid recursion affecting the value{% endcomment %}{% 
  if include.relevantTags.size > 0 %}{% 
    if include.relevantTags.first %}{% 
      assign relevantTagsArray = include.relevantTags %}{% 
    else %}{% 
      assign relevantTagsArray = include.relevantTags | replace: " ", "" | split: "," %}{% 
    endif %}{% 
  else %}{% 
      assign relevantTagsArray = "" %}{% 
  endif %}{% 
  if relevantTagsArray.size > 0 %}{% 
    capture tagsCompareResult %}{% 
      include /functions/find-array-match.html array1=item.tags array2=relevantTagsArray %}{% 
    endcapture %}{% 
    if tagsCompareResult contains "true" %}{% 
      assign relevantItem = true %}{% 
    else %}{% 
      assign relevantItem = false %}{% 
    endif %}{% 
  else %}{% 
    assign relevantItem = true %}{% 
  endif %}{% 
  capture rawOutput %}{% 
    comment %}{% endcomment %}{% 
    if item.content_type == 'section' %}{%
      comment %}Content block is a section, so output the section elements, the heading and then call this function to process the nested content array{% endcomment %}{% 
      if include.collapseSubsections == true %}{% 
        assign nextHeadingLevel = include.currHeadingLevel %}{% 
        assign sectionTag = "div" %}{% 
      else %}{% 
        assign nextHeadingLevel = include.currHeadingLevel | plus: 1 %}{% 
        assign sectionTag = item.source_element %}{% 
      endif %}{% 
      capture nestedOutputSection %}{% 
        include /functions/output-content-array.html contentArray=item.content currHeadingLevel=nextHeadingLevel relevantTags=include.relevantTags %}{% 
      endcapture %}{% 
      assign nestedOutputStrip = nestedOutputSection | strip %}{% 
      if relevantItem or nestedOutputStrip.size > 0 %}{% 
	assign source_element = item.source_element %}{% 
        if site.defaultClasses[source_element].size > 0 %}{% 
          assign allClasses = site.defaultClasses[source_element] | split: " " %}{% 
          if item.tags.size > 0 %}{% 
            assign allClasses = allClasses | concat: item.tags %}{% 
          endif %}{% 
        else %}{% 
          assign allClasses = item.tags %}{% 
        endif %}{% 
        capture classOutput %}{% 
          include /functions/class-from-tags.html tags=allClasses %}{% 
        endcapture %}
<{{ sectionTag }}{{ classOutput | rstrip }}>
{% unless include.collapseSubsections == true %}<h{{ nextHeadingLevel }}>{{ item.title }}</h{{ nextHeadingLevel }}>{% endunless %}
{{ nestedOutputStrip }}
</{{ sectionTag }}>
{%    endif %}{% 
    elsif item.content_type == 'inline' %}{%  
      comment %}Is inline content, so output the content as is{% endcomment 
%}{{ item.content }}{% 
    else %}{% 
      comment %}Is a content block, so output the source element and then call this function to process the nested content{% endcomment %}{% 
      capture nestedBlockContent %}{% 
        include /functions/output-content-array.html contentArray=item.content currHeadingLevel=include.currHeadingLevel relevantTags=include.relevantTags %}{% 
      endcapture %}{% 
      assign nestedBlockContentStrip = nestedBlockContent | rstrip %}{% 
      if relevantItem or nestedBlockContentStrip.size > 0 %}{% 
        if site.defaultClasses[item.source_element].size > 0 %}{% 
          assign allClasses = site.defaultClasses[item.source_element] | split: " " %}{% 
          if item.tags.size > 0 %}{% 
            assign allClasses = allClasses | concat: item.tags %}{% 
          endif %}{% 
        else %}{% 
          assign allClasses = item.tags %}{% 
        endif %}{% 
        comment %}Output all of the source attributes except for class{% endcomment %}{% 
        assign attributesOutput = "" %}{% 
        for attribute in item.source_attributes %}{% 
          assign attributeName = attribute[0] %}{% 
          assign attributeValue = attribute[1] %}{% 
          unless attributeName == "class" %}{% 
            assign attributesOutput = attributesOutput | append: ' ' | append: attributeName | append: '="' | append: attributeValue | append: '"' %}{%  
          endunless %}{% 
        endfor %}{% 
        capture classOutput %}{% 
          include /functions/class-from-tags.html tags=allClasses %}{% 
        endcapture %}
<{{ item.source_element }}{{ classOutput | rstrip }}{{ attributesOutput }}>
{{ nestedBlockContentStrip }}
</{{ item.source_element }}>
{%    endif %}{% 
    endif %}{% 
  endcapture %}{% 
  comment %}Special handling to ensure output is properly spaced (e.g., list items are on separate lines with no blank lines in between){% endcomment %}{{ rawOutput | lstrip }}{% 
endfor %}
